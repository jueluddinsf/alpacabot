<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlpacaBot Trading Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.4/socket.io.js"></script>
    <style>
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .profit-positive { color: #28a745; }
        .profit-negative { color: #dc3545; }
        .profit-neutral { color: #6c757d; }
        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
        .refresh-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        .summary-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-robot"></i> AlpacaBot Trading Dashboard
            </span>
            <div class="d-flex">
                <span id="last-update" class="text-light me-3">Last updated: Never</span>
                <button class="btn btn-light btn-sm" onclick="runTradingCycle()">
                    <i class="fas fa-play"></i> Run Cycle
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Portfolio Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card summary-card">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h5>Total Value</h5>
                                <h3 id="total-value">$0.00</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Profit/Loss</h5>
                                <h3 id="profit-loss" class="profit-neutral">$0.00</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Holdings</h5>
                                <h3 id="holdings-count">0</h3>
                            </div>
                            <div class="col-md-3">
                                <h5>Watchlist</h5>
                                <h3 id="watchlist-count">0</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> Strategy Configuration</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <strong>Min Price:</strong> $<span id="min-price">50</span>
                            </div>
                            <div class="col-md-2">
                                <strong>Drop Trigger:</strong> <span id="drop-threshold">30</span>%
                            </div>
                            <div class="col-md-2">
                                <strong>Profit Target:</strong> <span id="profit-target">10</span>%
                            </div>
                            <div class="col-md-2">
                                <strong>Lookback:</strong> <span id="lookback-days">7</span> days
                            </div>
                            <div class="col-md-2">
                                <strong>Universe:</strong> <span id="total-symbols">30</span> stocks
                            </div>
                            <div class="col-md-2">
                                <span id="trading-mode" class="badge bg-success">Paper Trading</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Holdings -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Current Holdings</h5>
                    </div>
                    <div class="card-body">
                        <div id="holdings-table">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading holdings...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Watchlist -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-eye"></i> Watchlist (Potential Entries)</h5>
                    </div>
                    <div class="card-body">
                        <div id="watchlist-table">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading watchlist...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trade History -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Recent Trades</h5>
                    </div>
                    <div class="card-body">
                        <div id="trades-table">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading trades...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Button -->
    <button class="btn btn-primary btn-lg refresh-button" onclick="refreshAll()">
        <i class="fas fa-sync-alt"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const socket = io();
        
        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        // Format percentage
        function formatPercent(value) {
            return (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
        }

        // Format date
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleString();
        }

        // Get profit/loss class
        function getProfitClass(value) {
            if (value > 0) return 'profit-positive';
            if (value < 0) return 'profit-negative';
            return 'profit-neutral';
        }

        // Load portfolio summary
        async function loadPortfolio() {
            try {
                const response = await fetch('/api/portfolio');
                const data = await response.json();
                
                document.getElementById('total-value').textContent = formatCurrency(data.total_value || 0);
                document.getElementById('profit-loss').textContent = formatCurrency(data.profit_loss || 0);
                document.getElementById('profit-loss').className = getProfitClass(data.profit_loss || 0);
                document.getElementById('holdings-count').textContent = data.holdings_count || 0;
                document.getElementById('watchlist-count').textContent = data.watchlist_count || 0;
            } catch (error) {
                console.error('Error loading portfolio:', error);
            }
        }

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                document.getElementById('min-price').textContent = data.min_stock_price;
                document.getElementById('drop-threshold').textContent = data.drop_threshold;
                document.getElementById('profit-target').textContent = data.profit_target;
                document.getElementById('lookback-days').textContent = data.lookback_days;
                document.getElementById('total-symbols').textContent = data.total_symbols;
                
                const modeElement = document.getElementById('trading-mode');
                if (data.paper_trading) {
                    modeElement.textContent = 'Paper Trading';
                    modeElement.className = 'badge bg-success';
                } else {
                    modeElement.textContent = 'Live Trading';
                    modeElement.className = 'badge bg-danger';
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        // Load holdings
        async function loadHoldings() {
            try {
                const response = await fetch('/api/holdings');
                const holdings = await response.json();
                
                const container = document.getElementById('holdings-table');
                
                if (holdings.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No current holdings</div>';
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Qty</th>
                                    <th>Buy Price</th>
                                    <th>Current</th>
                                    <th>P&L</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                holdings.forEach(holding => {
                    html += `
                        <tr>
                            <td><strong>${holding.symbol}</strong></td>
                            <td>${holding.quantity}</td>
                            <td>${formatCurrency(holding.buy_price)}</td>
                            <td>${formatCurrency(holding.current_price)}</td>
                            <td class="${getProfitClass(holding.profit_loss)}">
                                ${formatCurrency(holding.profit_loss)}<br>
                                <small>(${formatPercent(holding.profit_loss_pct)})</small>
                            </td>
                            <td>${formatCurrency(holding.market_value)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading holdings:', error);
                document.getElementById('holdings-table').innerHTML = 
                    '<div class="text-center text-danger">Error loading holdings</div>';
            }
        }

        // Load watchlist
        async function loadWatchlist() {
            try {
                const response = await fetch('/api/watchlist');
                const watchlist = await response.json();
                
                const container = document.getElementById('watchlist-table');
                
                if (watchlist.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No stocks in watchlist</div>';
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Entry Price</th>
                                    <th>Current</th>
                                    <th>Additional Drop</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                watchlist.forEach(item => {
                    html += `
                        <tr>
                            <td><strong>${item.symbol}</strong></td>
                            <td>${formatCurrency(item.drop_detected_price)}</td>
                            <td>${formatCurrency(item.current_price)}</td>
                            <td class="${getProfitClass(item.additional_drop_pct)}">
                                ${formatPercent(item.additional_drop_pct)}
                            </td>
                            <td>
                                <span class="badge bg-warning status-badge">${item.status}</span>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading watchlist:', error);
                document.getElementById('watchlist-table').innerHTML = 
                    '<div class="text-center text-danger">Error loading watchlist</div>';
            }
        }

        // Load trade history
        async function loadTrades() {
            try {
                const response = await fetch('/api/trades');
                const trades = await response.json();
                
                const container = document.getElementById('trades-table');
                
                if (trades.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">No recent trades</div>';
                    return;
                }

                let html = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Symbol</th>
                                    <th>Action</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                trades.slice(0, 10).forEach(trade => {
                    const badgeClass = trade.action === 'BUY' ? 'bg-success' : 'bg-danger';
                    html += `
                        <tr>
                            <td>${formatDate(trade.timestamp)}</td>
                            <td><strong>${trade.symbol}</strong></td>
                            <td><span class="badge ${badgeClass}">${trade.action}</span></td>
                            <td>${formatCurrency(trade.price)}</td>
                            <td>${trade.quantity}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading trades:', error);
                document.getElementById('trades-table').innerHTML = 
                    '<div class="text-center text-danger">Error loading trades</div>';
            }
        }

        // Run trading cycle
        async function runTradingCycle() {
            const button = event.target;
            const originalHtml = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/run-cycle', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Refresh all data after cycle completes
                    await refreshAll();
                    alert('Trading cycle completed successfully!');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error running cycle:', error);
                alert('Error running trading cycle');
            }
            
            button.innerHTML = originalHtml;
            button.disabled = false;
        }

        // Refresh all data
        async function refreshAll() {
            document.querySelector('.refresh-button').classList.add('loading');
            
            await Promise.all([
                loadPortfolio(),
                loadHoldings(),
                loadWatchlist(),
                loadTrades(),
                loadConfig()
            ]);
            
            document.getElementById('last-update').textContent = 
                'Last updated: ' + new Date().toLocaleTimeString();
            
            document.querySelector('.refresh-button').classList.remove('loading');
        }

        // Socket.IO event handlers
        socket.on('portfolio_update', function(data) {
            console.log('Portfolio update received:', data);
            loadPortfolio();
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            refreshAll();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshAll, 30000);
        });
    </script>
</body>
</html> 